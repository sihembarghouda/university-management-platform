import { 
  confirmPasswordReset, 
  verifyPasswordResetCode,
  applyActionCode,
  checkActionCode,
  sendPasswordResetEmail
} from 'firebase/auth';
import { auth } from '../config/firebase';
import axios from 'axios';

const AUTH_API_URL = process.env.REACT_APP_AUTH_API_URL || 'http://localhost:3000/api';

/**
 * Service pour g√©rer l'authentification Firebase
 */
const firebaseAuthService = {
  /**
   * Demander un lien de r√©initialisation de mot de passe
   * Utilise le BACKEND qui g√©n√®re le lien Firebase avec le bon domaine
   * Le backend s'assure que l'utilisateur existe dans Firebase
   */
  async requestPasswordReset(email) {
    try {
      console.log('üî• [Password Reset] Demande de r√©initialisation pour:', email);
      
      // Appeler le backend qui va:
      // 1. Cr√©er l'utilisateur dans Firebase si n√©cessaire
      // 2. G√©n√©rer un lien Firebase avec le bon domaine (localhost:3003)
      // 3. Envoyer l'email avec ce lien
      const response = await axios.post(`${AUTH_API_URL}/auth/forgot-password`, { email });
      
      console.log('‚úÖ [Password Reset] Email envoy√© avec succ√®s!');
      
      return {
        success: true,
        message: response.data.message || 'Un email de r√©initialisation a √©t√© envoy√©'
      };
    } catch (error) {
      console.error('‚ùå [Password Reset] Erreur:', error);
      throw error;
    }
  },

  /**
   * V√©rifier si le code de r√©initialisation Firebase est valide
   * @param {string} oobCode - Le code d'action Firebase (oobCode)
   * @returns {Promise<string>} - L'email associ√© au code
   */
  async verifyPasswordResetCode(oobCode) {
    try {
      const email = await verifyPasswordResetCode(auth, oobCode);
      console.log('‚úÖ Password reset code verified for:', email);
      return email;
    } catch (error) {
      console.error('‚ùå Error verifying password reset code:', error);
      throw error;
    }
  },

  /**
   * R√©initialiser le mot de passe avec Firebase
   * @param {string} oobCode - Le code d'action Firebase
   * @param {string} newPassword - Le nouveau mot de passe
   */
  async confirmPasswordReset(oobCode, newPassword) {
    try {
      await confirmPasswordReset(auth, oobCode, newPassword);
      console.log('‚úÖ Password reset successful via Firebase');
      return {
        success: true,
        message: 'Mot de passe r√©initialis√© avec succ√®s'
      };
    } catch (error) {
      console.error('‚ùå Error confirming password reset:', error);
      throw error;
    }
  },

  /**
   * R√©initialiser le mot de passe avec le backend (fallback si pas de Firebase)
   * @param {string} email - Email de l'utilisateur
   * @param {string} token - Token de r√©initialisation local
   * @param {string} newPassword - Le nouveau mot de passe
   */
  async resetPasswordWithToken(email, token, newPassword) {
    try {
      const response = await axios.post(`${AUTH_API_URL}/auth/reset-password`, {
        email,
        token,
        newPassword
      });
      return {
        success: true,
        message: response.data.message || 'Mot de passe r√©initialis√© avec succ√®s'
      };
    } catch (error) {
      console.error('Error resetting password with token:', error);
      throw error;
    }
  },

  /**
   * V√©rifier le type d'action Firebase (reset password, verify email, etc.)
   * @param {string} oobCode - Le code d'action Firebase
   */
  async checkActionCode(oobCode) {
    try {
      const info = await checkActionCode(auth, oobCode);
      console.log('‚úÖ Action code info:', info);
      return info;
    } catch (error) {
      console.error('‚ùå Error checking action code:', error);
      throw error;
    }
  },

  /**
   * Appliquer une action Firebase (par exemple, v√©rifier l'email)
   * @param {string} oobCode - Le code d'action Firebase
   */
  async applyActionCode(oobCode) {
    try {
      await applyActionCode(auth, oobCode);
      console.log('‚úÖ Action code applied successfully');
      return {
        success: true,
        message: 'Action appliqu√©e avec succ√®s'
      };
    } catch (error) {
      console.error('‚ùå Error applying action code:', error);
      throw error;
    }
  }
};

export default firebaseAuthService;
